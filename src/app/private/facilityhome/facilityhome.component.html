<div class="facility-shell">
  <header class="facility-header">
    <div class="header-left">
      <img src="/ZBLogo.jpg" alt="ZBB Logo" class="logo">
      <div>
        <p class="eyebrow">Facility Intake Workspace</p>
        <h1>{{ facilityDetails().name }}</h1>
        <p class="header-meta">{{ facilityDetails().address }}</p>
      </div>
    </div>
    <div class="header-actions">
      <a routerLink="/intakehub" class="btn btn-outline back-link">Back to Intake Hub</a>
      <a class="btn btn-primary" routerLink="/referral">Add New Intake</a>
    </div>
  </header>

  <div class="facility-body">
    <aside class="referral-sidebar">
      <div class="sidebar-card emphasis">
        <p class="label">Facility Contact</p>
        <h4>{{ facilityDetails().contact }}</h4>
        <p>{{ facilityDetails().contactEmail }}</p>
        <p>{{ facilityDetails().contactPhone }}</p>
      </div>

      <div class="sidebar-card emphasis">
        <p class="label">Your Account</p>
        <h4>{{ loggedInContact().name }}</h4>
        <p>{{ loggedInContact().email }}</p>
        <p>{{ loggedInContact().phone }}</p>
      </div>

      <div class="sidebar-divider"></div>

      <div class="sidebar-heading">
        <p class="eyebrow">Unsubmitted Drafts</p>
        <h3>In Progress</h3>
      </div>

      <div class="sidebar-list drafts">
        @if (!filteredDrafts().length) {
        <p class="empty-search">No unsubmitted drafts right now.</p>
        }
        @for (referral of filteredDrafts(); track referral.id) {
        <article class="referral-entry draft" [class.active]="selectedReferralId() === referral.id"
          (click)="selectReferral(referral.id)">
          <div>
            <span class="resident">{{ referral.resident || 'Unnamed Resident' }}</span>
            <p class="pill-meta">{{ referral.type || 'Unspecified' }} • {{ referral.submitted }}</p>
          </div>
          <span class="status draft">Draft</span>
          <div class="entry-meta">
            <p>{{ referral.shared.reason || 'Details pending' }}</p>
          </div>
          <div class="entry-actions">
            <button type="button" class="btn btn-light"
              (click)="selectReferral(referral.id); $event.stopPropagation()">Resume Draft</button>
          </div>
        </article>
        }
      </div>

      <div class="sidebar-heading">
        <p class="eyebrow">Submitted Residents</p>
        <h3>Previous Referrals</h3>
      </div>

      <div class="search-row">
        <label class="sr-only" for="referralSearch">Search residents</label>
        <input id="referralSearch" type="search" class="referral-search" placeholder="Search by resident name"
          (input)="updateSearch($any($event.target).value)" [value]="searchTerm()">
      </div>

      <div class="sidebar-list">
        @if (!filteredSubmissions().length) {
        <p class="empty-search">No residents found with that name.</p>
        }
        @for (referral of filteredSubmissions(); track referral.id) {
        <article class="referral-entry" [class.active]="selectedReferralId() === referral.id"
          (click)="selectReferral(referral.id)">
          <div class="entry-header">
            <div>
              <span class="resident">{{ referral.resident }}</span>
              <p class="pill-meta">{{ referral.type || 'Unspecified' }} • {{ referral.submitted }}</p>
            </div>
            <span class="status" [attr.data-status]="referral.status">{{ referral.status }}</span>
          </div>

          <div class="progress-block"
            *ngIf="referral.type !== 'Medicaid' && referral.guardianshipProgress !== undefined">
            <p>Guardianship Progress</p>
            <div class="progress-bar">
              <span [style.width.%]="referral.guardianshipProgress"></span>
            </div>
            <small>{{ referral.guardianshipProgress }}% Complete</small>
          </div>

          <div class="progress-block"
            *ngIf="referral.type !== 'Guardianship' && referral.medicaidProgress !== undefined">
            <p>Medicaid Progress</p>
            <div class="progress-bar medicaid">
              <span [style.width.%]="referral.medicaidProgress"></span>
            </div>
            <small>{{ referral.medicaidProgress }}% Complete</small>
          </div>

          <div class="entry-actions">
            <button type="button" class="btn btn-light"
              (click)="selectReferral(referral.id); $event.stopPropagation()">Review Referral</button>
            <button type="button" class="btn btn-outline-light">Review Case Updates</button>
          </div>
        </article>
        }
      </div>
    </aside>

    <main class="referral-panel">
      <ng-container *ngIf="selectedReferralPrefill() as prefill; else emptyState">
        <app-referralshared [prefillData]="prefill" [showHeroBar]="false"></app-referralshared>
      </ng-container>
    </main>
  </div>
</div>

<ng-template #emptyState>
  <div class="empty-panel">
    <h3>Select a referral to review details</h3>
    <p>The left column lists every form submitted by this facility.</p>
  </div>
</ng-template>
