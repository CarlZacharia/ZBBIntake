<!-- beneficiary-designation.component.html -->
<div class="beneficiary-designation" *ngIf="showBeneficiarySection">

  <!-- Header -->
  <div class="bene-header">
    <h3>Beneficiary Designation</h3>
    <p class="asset-info">
      <strong>{{ assetName }}</strong>
      <span class="asset-value">{{ formatCurrency(approximateValue) }}</span>
    </p>
  </div>

  <!-- Progress Steps -->
  <div class="step-progress">
    <div class="step" [class.active]="currentStep() === 'structure'" [class.completed]="currentStep() !== 'structure'">
      <span class="step-number">1</span>
      <span class="step-label">Structure</span>
    </div>
    <div class="step-connector"></div>
    <div class="step" [class.active]="currentStep() === 'scenario'"
         [class.completed]="['primary', 'secondary', 'review'].includes(currentStep())">
      <span class="step-number">2</span>
      <span class="step-label">Scenario</span>
    </div>
    <div class="step-connector"></div>
    <div class="step" [class.active]="currentStep() === 'primary'"
         [class.completed]="['secondary', 'review'].includes(currentStep())">
      <span class="step-number">3</span>
      <span class="step-label">Primary</span>
    </div>
    <div class="step-connector" *ngIf="designation().hasSecondary"></div>
    <div class="step" *ngIf="designation().hasSecondary"
         [class.active]="currentStep() === 'secondary'"
         [class.completed]="currentStep() === 'review'">
      <span class="step-number">4</span>
      <span class="step-label">Secondary</span>
    </div>
    <div class="step-connector"></div>
    <div class="step" [class.active]="currentStep() === 'review'">
      <span class="step-number">{{ designation().hasSecondary ? '5' : '4' }}</span>
      <span class="step-label">Review</span>
    </div>
  </div>

  <!-- Step 1: Structure Choice -->
  <div class="step-content" *ngIf="currentStep() === 'structure'">
    <h4>Beneficiary Structure</h4>
    <p class="step-description">
      How would you like to structure the beneficiary designations for this asset?
    </p>

    <div class="option-cards">
      <div class="option-card"
           [class.selected]="designation().hasSecondary"
           (click)="onStructureChange(true)">
        <div class="option-icon">üë•</div>
        <h5>Primary &amp; Secondary</h5>
        <p>Typical for married couples. Spouse receives first, then others if spouse predeceases.</p>
        <span class="recommended" *ngIf="isMarried">Recommended</span>
      </div>

      <div class="option-card"
           [class.selected]="!designation().hasSecondary"
           (click)="onStructureChange(false)">
        <div class="option-icon">üë§</div>
        <h5>Primary Only</h5>
        <p>Single tier of beneficiaries. All named beneficiaries share equally or by percentage.</p>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="onCancel()">Cancel</button>
      <button class="btn-primary" (click)="nextStep()">Continue</button>
    </div>
  </div>

  <!-- Step 2: Scenario Selection -->
  <div class="step-content" *ngIf="currentStep() === 'scenario'">
    <h4>Planning Scenario</h4>

    <div *ngIf="scenarioOptions().requireScenarioChoice; else autoScenario">
      <p class="step-description">
        Since this asset is jointly owned, which scenario would you like to plan for?
      </p>

      <div class="scenario-options">
        <div class="scenario-card"
             [class.selected]="designation().scenario === 'client_dies_first'"
             (click)="onScenarioChange('client_dies_first')"
             *ngIf="scenarioOptions().showClientDiesFirst">
          <div class="scenario-header">
            <span class="scenario-icon">‚ö∞Ô∏è</span>
            <h5>{{ clientName }} Dies First</h5>
          </div>
          <p>Plan beneficiaries assuming {{ clientName }} predeceases {{ spouseName }}.</p>
        </div>

        <div class="scenario-card"
             [class.selected]="designation().scenario === 'spouse_dies_first'"
             (click)="onScenarioChange('spouse_dies_first')"
             *ngIf="scenarioOptions().showSpouseDiesFirst">
          <div class="scenario-header">
            <span class="scenario-icon">‚ö∞Ô∏è</span>
            <h5>{{ spouseName }} Dies First</h5>
          </div>
          <p>Plan beneficiaries assuming {{ spouseName }} predeceases {{ clientName }}.</p>
        </div>
      </div>
    </div>

    <ng-template #autoScenario>
      <div class="auto-scenario-notice">
        <p>
          <strong>Scenario:</strong> {{ getScenarioLabel(designation().scenario) }}
        </p>
        <p class="muted">
          Based on asset ownership ({{ ownedBy }}), this is the applicable planning scenario.
        </p>
      </div>
    </ng-template>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Back</button>
      <button class="btn-primary" (click)="nextStep()" [disabled]="!canProceedToPrimary">
        Continue
      </button>
    </div>
  </div>

  <!-- Step 3: Primary Beneficiaries -->
  <div class="step-content" *ngIf="currentStep() === 'primary'">
    <h4>Primary Beneficiaries</h4>
    <p class="step-description">
      Select who should receive this asset first.
      <span class="scenario-badge">{{ getScenarioLabel(designation().scenario) }}</span>
    </p>

    <!-- Heir Selection -->
    <div class="heir-selection">
      <div class="heir-item" *ngFor="let heir of designation().primaryBeneficiaries">
        <label class="heir-checkbox">
          <input type="checkbox"
                 [checked]="heir.selected"
                 (change)="onPrimaryBeneficiaryToggle(heir)">
          <span class="heir-icon">{{ getHeirTypeIcon(heir.type) }}</span>
          <span class="heir-name">{{ heir.name }}</span>
          <span class="heir-type-badge">{{ heir.type }}</span>
        </label>
      </div>
    </div>

    <!-- Distribution Type -->
    <div class="distribution-section" *ngIf="designation().primaryBeneficiaries.some(b => b.selected)">
      <h5>Distribution</h5>

      <div class="distribution-toggle">
        <button [class.active]="designation().primaryDistribution === 'equal'"
                (click)="onDistributionTypeChange('primary', 'equal')">
          Equal Shares
        </button>
        <button [class.active]="designation().primaryDistribution === 'unequal'"
                (click)="onDistributionTypeChange('primary', 'unequal')">
          Custom Percentages
        </button>
      </div>

      <!-- Percentage Entry -->
      <div class="percentage-grid" *ngIf="designation().primaryDistribution === 'unequal'">
        <div class="percentage-row"
             *ngFor="let heir of designation().primaryBeneficiaries"
             [class.hidden]="!heir.selected">
          <span class="heir-label">{{ heir.name }}</span>
          <div class="percentage-input">
            <input type="number"
                   [ngModel]="heir.percentage"
                   (ngModelChange)="onPercentageChange('primary', heir.id, $event)"
                   min="0" max="100" step="0.01">
            <span>%</span>
          </div>
          <span class="calculated-value">{{ formatCurrency(heir.calculatedValue) }}</span>
          <label class="per-stirpes">
            <input type="checkbox"
                   [ngModel]="heir.perStirpes"
                   (ngModelChange)="onPerStirpesChange('primary', heir.id, $event)">
            Per Stirpes
          </label>
        </div>
      </div>

      <!-- Equal Distribution Display -->
      <div class="equal-distribution-display" *ngIf="designation().primaryDistribution === 'equal'">
        <div class="equal-row"
             *ngFor="let heir of designation().primaryBeneficiaries"
             [class.hidden]="!heir.selected">
          <span class="heir-label">{{ heir.name }}</span>
          <span class="percentage">{{ heir.percentage | number:'1.2-2' }}%</span>
          <span class="calculated-value">{{ formatCurrency(heir.calculatedValue) }}</span>
          <label class="per-stirpes">
            <input type="checkbox"
                   [ngModel]="heir.perStirpes"
                   (ngModelChange)="onPerStirpesChange('primary', heir.id, $event)">
            Per Stirpes
          </label>
        </div>
      </div>

      <!-- Validation Message -->
      <div class="validation-message" [class.error]="!primaryValidation().isValid">
        <span *ngIf="primaryValidation().isValid" class="success">‚úì Total: 100%</span>
        <span *ngIf="!primaryValidation().isValid" class="error">
          {{ primaryValidation().message }}
        </span>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Back</button>
      <button class="btn-primary"
              (click)="nextStep()"
              [disabled]="!canProceedToSecondary">
        {{ designation().hasSecondary ? 'Continue to Secondary' : 'Review' }}
      </button>
    </div>
  </div>

  <!-- Step 4: Secondary Beneficiaries -->
  <div class="step-content" *ngIf="currentStep() === 'secondary'">
    <h4>Secondary (Contingent) Beneficiaries</h4>
    <p class="step-description">
      Select who should receive this asset if the primary beneficiaries predecease the owner.
    </p>

    <div class="primary-reminder">
      <strong>Primary:</strong>
      <span *ngFor="let heir of designation().primaryBeneficiaries; let last = last">
        <span *ngIf="heir.selected">{{ heir.name }} ({{ heir.percentage | number:'1.0-0' }}%){{ last ? '' : ', ' }}</span>
      </span>
    </div>

    <!-- Heir Selection (excluding sole primary if only one) -->
    <div class="heir-selection">
      <div class="heir-item"
           *ngFor="let heir of designation().secondaryBeneficiaries"
           [class.disabled]="designation().primaryBeneficiaries.length === 1 &&
                             designation().primaryBeneficiaries[0]?.id === heir.id">
        <label class="heir-checkbox">
          <input type="checkbox"
                 [checked]="heir.selected"
                 (change)="onSecondaryBeneficiaryToggle(heir)"
                 [disabled]="designation().primaryBeneficiaries.length === 1 &&
                             designation().primaryBeneficiaries[0]?.id === heir.id">
          <span class="heir-icon">{{ getHeirTypeIcon(heir.type) }}</span>
          <span class="heir-name">{{ heir.name }}</span>
          <span class="heir-type-badge">{{ heir.type }}</span>
        </label>
      </div>
    </div>

    <!-- Distribution Type -->
    <div class="distribution-section" *ngIf="designation().secondaryBeneficiaries.some(b => b.selected)">
      <h5>Distribution</h5>

      <div class="distribution-toggle">
        <button [class.active]="designation().secondaryDistribution === 'equal'"
                (click)="onDistributionTypeChange('secondary', 'equal')">
          Equal Shares
        </button>
        <button [class.active]="designation().secondaryDistribution === 'unequal'"
                (click)="onDistributionTypeChange('secondary', 'unequal')">
          Custom Percentages
        </button>
      </div>

      <!-- Percentage Entry -->
      <div class="percentage-grid" *ngIf="designation().secondaryDistribution === 'unequal'">
        <div class="percentage-row"
             *ngFor="let heir of designation().secondaryBeneficiaries"
             [class.hidden]="!heir.selected">
          <span class="heir-label">{{ heir.name }}</span>
          <div class="percentage-input">
            <input type="number"
                   [ngModel]="heir.percentage"
                   (ngModelChange)="onPercentageChange('secondary', heir.id, $event)"
                   min="0" max="100" step="0.01">
            <span>%</span>
          </div>
          <span class="calculated-value">{{ formatCurrency(heir.calculatedValue) }}</span>
          <label class="per-stirpes">
            <input type="checkbox"
                   [ngModel]="heir.perStirpes"
                   (ngModelChange)="onPerStirpesChange('secondary', heir.id, $event)">
            Per Stirpes
          </label>
        </div>
      </div>

      <!-- Equal Distribution Display -->
      <div class="equal-distribution-display" *ngIf="designation().secondaryDistribution === 'equal'">
        <div class="equal-row"
             *ngFor="let heir of designation().secondaryBeneficiaries"
             [class.hidden]="!heir.selected">
          <span class="heir-label">{{ heir.name }}</span>
          <span class="percentage">{{ heir.percentage | number:'1.2-2' }}%</span>
          <span class="calculated-value">{{ formatCurrency(heir.calculatedValue) }}</span>
          <label class="per-stirpes">
            <input type="checkbox"
                   [ngModel]="heir.perStirpes"
                   (ngModelChange)="onPerStirpesChange('secondary', heir.id, $event)">
            Per Stirpes
          </label>
        </div>
      </div>

      <!-- Validation Message -->
      <div class="validation-message" [class.error]="!secondaryValidation().isValid">
        <span *ngIf="secondaryValidation().isValid" class="success">‚úì Total: 100%</span>
        <span *ngIf="!secondaryValidation().isValid" class="error">
          {{ secondaryValidation().message }}
        </span>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Back</button>
      <button class="btn-primary" (click)="nextStep()">Review</button>
    </div>
  </div>

  <!-- Step 5: Review -->
  <div class="step-content" *ngIf="currentStep() === 'review'">
    <h4>Review Beneficiary Designation</h4>

    <div class="review-summary">
      <div class="review-section">
        <h5>Asset</h5>
        <p>{{ assetName }}</p>
        <p class="asset-value">{{ formatCurrency(approximateValue) }}</p>
      </div>

      <div class="review-section">
        <h5>Planning Scenario</h5>
        <p>{{ getScenarioLabel(designation().scenario) }}</p>
      </div>

      <div class="review-section">
        <h5>Primary Beneficiaries</h5>
        <table class="review-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>%</th>
              <th>Value</th>
              <th>Per Stirpes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let heir of designation().primaryBeneficiaries" [class.hidden]="!heir.selected">
              <td>{{ heir.name }}</td>
              <td>{{ heir.type }}</td>
              <td>{{ heir.percentage | number:'1.2-2' }}%</td>
              <td>{{ formatCurrency(heir.calculatedValue) }}</td>
              <td>{{ heir.perStirpes ? 'Yes' : 'No' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="review-section" *ngIf="designation().hasSecondary && designation().secondaryBeneficiaries.some(b => b.selected)">
        <h5>Secondary Beneficiaries</h5>
        <table class="review-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>%</th>
              <th>Value</th>
              <th>Per Stirpes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let heir of designation().secondaryBeneficiaries" [class.hidden]="!heir.selected">
              <td>{{ heir.name }}</td>
              <td>{{ heir.type }}</td>
              <td>{{ heir.percentage | number:'1.2-2' }}%</td>
              <td>{{ formatCurrency(heir.calculatedValue) }}</td>
              <td>{{ heir.perStirpes ? 'Yes' : 'No' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="step-actions">
      <button class="btn-secondary" (click)="prevStep()">Back</button>
      <button class="btn-primary btn-save"
              (click)="onSave()"
              [disabled]="!canSave">
        Save Beneficiary Designation
      </button>
    </div>
  </div>
</div>

<!-- Collapsed state when has_bene is not 'Yes' -->
<div class="beneficiary-prompt" *ngIf="!showBeneficiarySection">
  <p class="muted">Set "Has Beneficiary Designation" to "Yes" to configure beneficiaries.</p>
</div>
